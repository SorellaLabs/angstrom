use std::{
    collections::{HashMap, HashSet},
    sync::Arc
};

use alloy::{
    network::Ethereum,
    primitives::{Address, address},
    providers::{Provider, ProviderBuilder, ext::DebugApi},
    rpc::types::{self as alloy_rpc_types, BlockId, BlockNumberOrTag, Filter},
    sol_types::SolEvent
};
use alloy_primitives::{B256, BlockNumber, I256, U256, aliases::I24};
use angstrom::components::initialize_strom_handles;
use angstrom_eth::manager::EthEvent;
use angstrom_types::{
    block_sync::GlobalBlockSync,
    contract_bindings::{angstrom::Angstrom::PoolKey, controller_v_1::ControllerV1::*},
    contract_payloads::angstrom::{AngstromPoolConfigStore, UniswapAngstromRegistry},
    matching::SqrtPriceX96,
    pair_with_price::PairsWithPrice,
    primitive::*,
    reth_db_wrapper::{DBError, SetBlock},
    sol_bindings::Ray
};
use eyre::eyre;
use futures::StreamExt;
use matching_engine::MatchingManager;
use reth::{
    primitives::EthPrimitives,
    providers::{BlockHashReader, BlockNumReader, ProviderResult},
    revm as reth_revm,
    tasks::TokioTaskExecutor
};
use reth_provider::{CanonStateNotification, CanonStateSubscriptions, NodePrimitivesProvider};
use revm::{bytecode::Bytecode, state::AccountInfo};
use serde::{Deserialize, Serialize};
use testing_tools::type_generator::orders::UserOrderBuilder;
use tracing::*;
use tracing_subscriber::{prelude::__tracing_subscriber_SubscriberExt, util::SubscriberInitExt, *};
use uniswap_v4::{
    configure_uniswap_manager,
    uniswap::{
        pool::SwapResult,
        pool_manager::{SyncedUniswapPool, SyncedUniswapPools}
    }
};
use validation::{common::TokenPriceGenerator, init_validation, validator::ValidationClient};

const PAYLOAD: [u8; 22554] = alloy::hex!(
    "5b5b7b226f72646572223a7b225061727469616c466c617368223a7b227265665f6964223a302c226d696e5f616d6f756e745f696e223a32393135313033343433323631343832382c226d61785f616d6f756e745f696e223a35353435383036353530353935303136382c226d61785f65787472615f6665655f617373657430223a33363933313737393432303030302c226d696e5f7072696365223a22307833613930356439626231346533653030222c227573655f696e7465726e616c223a66616c73652c2261737365745f696e223a22307863303261616133396232323366653864306130653563346632376561643930383363373536636332222c2261737365745f6f7574223a22307864616331376639353864326565353233613232303632303639393435393763313364383331656337222c22726563697069656e74223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22686f6f6b5f64617461223a223078222c2276616c69645f666f725f626c6f636b223a32333131323432362c226d657461223a7b2269734563647361223a747275652c2266726f6d223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c227369676e6174757265223a22307830313030313161393663353431643837663532393734346437633964643465393339393766323838396533376131663831396539383165646465643230643739326233613533393931313239313332656535376337643330323030333236323533656665653036383831643061396232386637313365333636303139653538316466227d7d7d2c227072696f726974795f64617461223a7b227072696365223a22307833613930356439626231346533653030222c22766f6c756d65223a35353435383036353530353935303136382c22676173223a223078323135393438666438343630222c226761735f756e697473223a39323030307d2c22696e76616c696461746573223a5b5d2c22706f6f6c5f6964223a22307835336635383462366534346361613432653764653466303630656139386337366663363733343837326666653232613238313864353363333839666138623063222c2269735f63757272656e746c795f76616c6964223a6e756c6c2c2269735f626964223a66616c73652c2269735f76616c6964223a747275652c2276616c69645f626c6f636b223a32333131323432352c226f726465725f6964223a7b2261646472657373223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22706f6f6c5f6964223a22307835336635383462366534346361613432653764653466303630656139386337366663363733343837326666653232613238313864353363333839666138623063222c2268617368223a22307833656165616133663234326430376533393935623538313339616535343964373039373834373333663361616236356638653139633734633838343565616439222c2272657573655f61766f6964616e6365223a7b22426c6f636b223a32333131323432367d2c22646561646c696e65223a6e756c6c2c22666c6173685f626c6f636b223a32333131323432362c226c6f636174696f6e223a224c696d6974227d2c22746f625f726577617264223a22307830222c2263616e63656c5f726571756573746564223a66616c73657d2c7b226f72646572223a7b225061727469616c466c617368223a7b227265665f6964223a302c226d696e5f616d6f756e745f696e223a32393135313033343433323631343832382c226d61785f616d6f756e745f696e223a35353435383036353530353935303136382c226d61785f65787472615f6665655f617373657430223a3135353936322c226d696e5f7072696365223a22307833613931353535633064633034653030222c227573655f696e7465726e616c223a66616c73652c2261737365745f696e223a22307863303261616133396232323366653864306130653563346632376561643930383363373536636332222c2261737365745f6f7574223a22307861306238363939316336323138623336633164313964346132653965623063653336303665623438222c22726563697069656e74223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22686f6f6b5f64617461223a223078222c2276616c69645f666f725f626c6f636b223a32333131323432362c226d657461223a7b2269734563647361223a747275652c2266726f6d223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c227369676e6174757265223a22307830306233313634636234633462656666353938366230653433653538393638376231383935663837393064333361616237323934333438353030653536656337663333353533336362646631346364333432303035633262363437333036633737613866333030356563366265373132313632393763313331316332356163393961227d7d7d2c227072696f726974795f64617461223a7b227072696365223a22307833613931353535633064633034653030222c22766f6c756d65223a35353435383036353530353935303136382c22676173223a2230783235636432222c226761735f756e697473223a39323030307d2c22696e76616c696461746573223a5b5d2c22706f6f6c5f6964223a22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430222c2269735f63757272656e746c795f76616c6964223a6e756c6c2c2269735f626964223a747275652c2269735f76616c6964223a747275652c2276616c69645f626c6f636b223a32333131323432352c226f726465725f6964223a7b2261646472657373223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22706f6f6c5f6964223a22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430222c2268617368223a22307866643066363566356165636637613463383563316630616431353763313161306361346538356339386231373137323632333139643064653436333136323964222c2272657573655f61766f6964616e6365223a7b22426c6f636b223a32333131323432367d2c22646561646c696e65223a6e756c6c2c22666c6173685f626c6f636b223a32333131323432362c226c6f636174696f6e223a224c696d6974227d2c22746f625f726577617264223a22307830222c2263616e63656c5f726571756573746564223a66616c73657d2c7b226f72646572223a7b225061727469616c466c617368223a7b227265665f6964223a302c226d696e5f616d6f756e745f696e223a3132333030303030302c226d61785f616d6f756e745f696e223a3233343030303030302c226d61785f65787472615f6665655f617373657430223a3135353936322c226d696e5f7072696365223a223078326461373561356264373531656530303030303030303030303030303030222c227573655f696e7465726e616c223a66616c73652c2261737365745f696e223a22307861306238363939316336323138623336633164313964346132653965623063653336303665623438222c2261737365745f6f7574223a22307863303261616133396232323366653864306130653563346632376561643930383363373536636332222c22726563697069656e74223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22686f6f6b5f64617461223a223078222c2276616c69645f666f725f626c6f636b223a32333131323432362c226d657461223a7b2269734563647361223a747275652c2266726f6d223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c227369676e6174757265223a22307830303931653638366231653064643835366331663262666466663636656463353331646439626132663332353338626336346332306138386139373236363335376530663166313939633936623637323366633039626639666130393565353430356431626565636639366331626562316663316466313336646464376363336131227d7d7d2c227072696f726974795f64617461223a7b227072696365223a223078326461373561356264373531656530303030303030303030303030303030222c22766f6c756d65223a3233343030303030302c22676173223a2230783235636432222c226761735f756e697473223a39323030307d2c22696e76616c696461746573223a5b5d2c22706f6f6c5f6964223a22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430222c2269735f63757272656e746c795f76616c6964223a6e756c6c2c2269735f626964223a66616c73652c2269735f76616c6964223a747275652c2276616c69645f626c6f636b223a32333131323432352c226f726465725f6964223a7b2261646472657373223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22706f6f6c5f6964223a22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430222c2268617368223a22307832636464316339616163306336643564316630323235613233363830653131376131386164643439386362366434623564366635323762333638373739386366222c2272657573655f61766f6964616e6365223a7b22426c6f636b223a32333131323432367d2c22646561646c696e65223a6e756c6c2c22666c6173685f626c6f636b223a32333131323432362c226c6f636174696f6e223a224c696d6974227d2c22746f625f726577617264223a22307830222c2263616e63656c5f726571756573746564223a66616c73657d5d2c5b7b226f72646572223a7b227175616e746974795f696e223a3732333037333336303233373839363730342c227175616e746974795f6f7574223a333035313832303237312c226d61785f6761735f617373657430223a3237313233392c227573655f696e7465726e616c223a66616c73652c2261737365745f696e223a22307863303261616133396232323366653864306130653563346632376561643930383363373536636332222c2261737365745f6f7574223a22307861306238363939316336323138623336633164313964346132653965623063653336303665623438222c22726563697069656e74223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c2276616c69645f666f725f626c6f636b223a32333131323432362c226d657461223a7b2269734563647361223a747275652c2266726f6d223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c227369676e6174757265223a22307830306330666531656534666266323465376261663737376439396365666366373234376635366635323034323863366433383366393962313164333735383736353230323535633732336430666630326137346633306436366363306234343963373236663764646634616235323735643366363135373366663263663263353332227d7d2c227072696f726974795f64617461223a7b227072696365223a22307830222c22766f6c756d65223a3732333037333336303233373839363730342c22676173223a2230783431626464222c226761735f756e697473223a3136303030307d2c22696e76616c696461746573223a5b5d2c22706f6f6c5f6964223a22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430222c2269735f63757272656e746c795f76616c6964223a6e756c6c2c2269735f626964223a747275652c2269735f76616c6964223a747275652c2276616c69645f626c6f636b223a32333131323432352c226f726465725f6964223a7b2261646472657373223a22307837336435333535336565353532633166326139373232653634303764343365343165313935393366222c22706f6f6c5f6964223a22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430222c2268617368223a22307837616238616437623534376265383139636666343135626331326561376462353765373462316631633731383463373438633763336236323234376364343632222c2272657573655f61766f6964616e6365223a7b22426c6f636b223a32333131323432367d2c22646561646c696e65223a6e756c6c2c22666c6173685f626c6f636b223a32333131323432362c226c6f636174696f6e223a225365617263686572227d2c22746f625f726577617264223a2230783366633565222c2263616e63656c5f726571756573746564223a66616c73657d5d2c7b22307835336635383462366534346361613432653764653466303630656139386337366663363733343837326666653232613238313864353363333839666138623063223a5b22307863303261616133396232323366653864306130653563346632376561643930383363373536636332222c22307864616331376639353864326565353233613232303632303639393435393763313364383331656337222c7b226c6971756964697479223a7b227469636b5f73706163696e67223a31302c2273746172745f7469636b223a2d3139323834312c2273746172745f737172745f7072696365223a223078343432303937343830663564336163323764313966222c2273746172745f6c6971756964697479223a31373536353431373930373732343835392c22696e697469616c697a65645f7469636b73223a7b222d383837323730223a7b226c69717569646974795f67726f7373223a343038393638323735383330342c226c69717569646974795f6e6574223a343038393638323735383330342c22696e697469616c697a6564223a747275657d2c222d313936323930223a7b226c69717569646974795f67726f7373223a3233343630363331313436323430352c226c69717569646974795f6e6574223a3233343630363331313436323430352c22696e697469616c697a6564223a747275657d2c222d313936333630223a7b226c69717569646974795f67726f7373223a3737383936363938393331343438372c226c69717569646974795f6e6574223a3737383936363938393331343438372c22696e697469616c697a6564223a747275657d2c222d313931343430223a7b226c69717569646974795f67726f7373223a323934333238353738343337343134362c226c69717569646974795f6e6574223a2d323934333238353738343337343134362c22696e697469616c697a6564223a747275657d2c222d313932323730223a7b226c69717569646974795f67726f7373223a3737383936363938393331343438372c226c69717569646974795f6e6574223a2d3737383936363938393331343438372c22696e697469616c697a6564223a747275657d2c222d313932373230223a7b226c69717569646974795f67726f7373223a33313430373934373731333334362c226c69717569646974795f6e6574223a2d33313430373934373731333334362c22696e697469616c697a6564223a747275657d2c222d313936353330223a7b226c69717569646974795f67726f7373223a31333536363830343630343435383632312c226c69717569646974795f6e6574223a31333536363830343630343435383632312c22696e697469616c697a6564223a747275657d2c222d313935373530223a7b226c69717569646974795f67726f7373223a33313430373934373731333334362c226c69717569646974795f6e6574223a33313430373934373731333334362c22696e697469616c697a6564223a747275657d2c222d313932363730223a7b226c69717569646974795f67726f7373223a31333536363830343630343435383632312c226c69717569646974795f6e6574223a2d31333536363830343630343435383632312c22696e697469616c697a6564223a747275657d2c222d313933343030223a7b226c69717569646974795f67726f7373223a363235363538373634333535302c226c69717569646974795f6e6574223a363235363538373634333535302c22696e697469616c697a6564223a747275657d2c222d313936383230223a7b226c69717569646974795f67726f7373223a323934333238353738343337343134362c226c69717569646974795f6e6574223a323934333238353738343337343134362c22696e697469616c697a6564223a747275657d2c222d313934383330223a7b226c69717569646974795f67726f7373223a343933343233303434343831302c226c69717569646974795f6e6574223a343933343233303434343831302c22696e697469616c697a6564223a747275657d2c222d313934303230223a7b226c69717569646974795f67726f7373223a333137333833303130343433302c226c69717569646974795f6e6574223a2d333137333833303130343433302c22696e697469616c697a6564223a747275657d2c222d313934323230223a7b226c69717569646974795f67726f7373223a333137333833303130343433302c226c69717569646974795f6e6574223a333137333833303130343433302c22696e697469616c697a6564223a747275657d2c222d313933393530223a7b226c69717569646974795f67726f7373223a323231383236343234333935343038392c226c69717569646974795f6e6574223a323231383236343234333935343038392c22696e697469616c697a6564223a747275657d2c222d313933373530223a7b226c69717569646974795f67726f7373223a323231383236343234333935343038392c226c69717569646974795f6e6574223a2d323231383236343234333935343038392c22696e697469616c697a6564223a747275657d2c222d313933313830223a7b226c69717569646974795f67726f7373223a343933343233303434343831302c226c69717569646974795f6e6574223a2d343933343233303434343831302c22696e697469616c697a6564223a747275657d2c222d313932343030223a7b226c69717569646974795f67726f7373223a363235363538373634333535302c226c69717569646974795f6e6574223a2d363235363538373634333535302c22696e697469616c697a6564223a747275657d2c222d313932323430223a7b226c69717569646974795f67726f7373223a3233343630363331313436323430352c226c69717569646974795f6e6574223a2d3233343630363331313436323430352c22696e697469616c697a6564223a747275657d7d2c227469636b5f6269746d6170223a7b222d3736223a2230783132303031303030303030323130303030303030303030303430303030313030303030303030323030303032303430303030343030303030303030222c222d3735223a223078313030303030303030303030303030222c222d3737223a22307832303030303030303030303030303030303030303030303230303030303030303030303030383130303030383030303030303430303030303030222c222d333437223a223078323030303030303030303030303030303030303030303030303030227d7d2c22626c6f636b223a302c22666565223a3335307d2c315d2c22307834646537316430313163306261353433393964663833383437656164356262306162353638326165653336346130393736303463623763313635393061373430223a5b22307861306238363939316336323138623336633164313964346132653965623063653336303665623438222c22307863303261616133396232323366653864306130653563346632376561643930383363373536636332222c7b226c6971756964697479223a7b227469636b5f73706163696e67223a31302c2273746172745f7469636b223a3139323833392c2273746172745f737172745f7072696365223a22307833633165616535383735373830333533646434363334326537663166222c2273746172745f6c6971756964697479223a3238393933363333343431323037353030392c22696e697469616c697a65645f7469636b73223a7b22343730343930223a7b226c69717569646974795f67726f7373223a3834383533313833313331343430352c226c69717569646974795f6e6574223a2d3834383533313833313331343430352c22696e697469616c697a6564223a747275657d2c22313931373530223a7b226c69717569646974795f67726f7373223a3630363339373034313331313530302c226c69717569646974795f6e6574223a3630363339373034313331313530302c22696e697469616c697a6564223a747275657d2c22313930373630223a7b226c69717569646974795f67726f7373223a313032373538383938353237383536322c226c69717569646974795f6e6574223a313032373538383938353237383536322c22696e697469616c697a6564223a747275657d2c22313932343130223a7b226c69717569646974795f67726f7373223a31323231333131393337313533393331312c226c69717569646974795f6e6574223a31323231333131393337313533393331312c22696e697469616c697a6564223a747275657d2c22313933333630223a7b226c69717569646974795f67726f7373223a313634393139313837343430323337322c226c69717569646974795f6e6574223a3735323231373034303333363439362c22696e697469616c697a6564223a747275657d2c22313932343330223a7b226c69717569646974795f67726f7373223a3736343730373634313337353334312c226c69717569646974795f6e6574223a3736343730373634313337353334312c22696e697469616c697a6564223a747275657d2c22313933303730223a7b226c69717569646974795f67726f7373223a373730343837363434303832322c226c69717569646974795f6e6574223a373730343837363434303832322c22696e697469616c697a6564223a747275657d2c22313933313530223a7b226c69717569646974795f67726f7373223a333934393531373737303530323435302c226c69717569646974795f6e6574223a333934393531373737303530323435302c22696e697469616c697a6564223a747275657d2c22313937313030223a7b226c69717569646974795f67726f7373223a32343536313938383639383639352c226c69717569646974795f6e6574223a2d32343536313938383639383639352c22696e697469616c697a6564223a747275657d2c22313935313030223a7b226c69717569646974795f67726f7373223a3239313238323436323339373538382c226c69717569646974795f6e6574223a2d3239313238323436323339373538382c22696e697469616c697a6564223a747275657d2c22313934333530223a7b226c69717569646974795f67726f7373223a3835353836393931393838323731312c226c69717569646974795f6e6574223a2d3835353836393931393838323731312c22696e697469616c697a6564223a747275657d2c22313935363130223a7b226c69717569646974795f67726f7373223a31303632363630313933363732353737342c226c69717569646974795f6e6574223a2d31303632363630313933363732353737342c22696e697469616c697a6564223a747275657d2c22313934313630223a7b226c69717569646974795f67726f7373223a373637313537323335393234333230392c226c69717569646974795f6e6574223a2d373637313537323335393234333230392c22696e697469616c697a6564223a747275657d2c22313933393530223a7b226c69717569646974795f67726f7373223a3530303239373139303132363730362c226c69717569646974795f6e6574223a2d3530303239373139303132363730362c22696e697469616c697a6564223a747275657d2c22323030303230223a7b226c69717569646974795f67726f7373223a36333239393332363532313434392c226c69717569646974795f6e6574223a2d36333239393332363532313434392c22696e697469616c697a6564223a747275657d2c22313936383630223a7b226c69717569646974795f67726f7373223a3835383137313032393339332c226c69717569646974795f6e6574223a2d3835383137313032393339332c22696e697469616c697a6564223a747275657d2c22313834373330223a7b226c69717569646974795f67726f7373223a363335393231323336393236373431372c226c69717569646974795f6e6574223a363335393231323336393236373431372c22696e697469616c697a6564223a747275657d2c22313931393830223a7b226c69717569646974795f67726f7373223a3738393030303838333735313338342c226c69717569646974795f6e6574223a3738393030303838333735313338342c22696e697469616c697a6564223a747275657d2c22313931313030223a7b226c69717569646974795f67726f7373223a3437383733383937373637393932362c226c69717569646974795f6e6574223a3437383733383937373637393932362c22696e697469616c697a6564223a747275657d2c22313932303130223a7b226c69717569646974795f67726f7373223a313433303738383234343238353439392c226c69717569646974795f6e6574223a313433303738383234343238353439392c22696e697469616c697a6564223a747275657d2c22313932333230223a7b226c69717569646974795f67726f7373223a3736363434373032313531343032362c226c69717569646974795f6e6574223a3736363434373032313531343032362c22696e697469616c697a6564223a747275657d2c22313932343630223a7b226c69717569646974795f67726f7373223a32383837373831353231353736353538392c226c69717569646974795f6e6574223a32383837373831353231353736353538392c22696e697469616c697a6564223a747275657d2c22313933323130223a7b226c69717569646974795f67726f7373223a3436323639303436313336333632302c226c69717569646974795f6e6574223a3436323639303436313336333632302c22696e697469616c697a6564223a747275657d2c22313933363130223a7b226c69717569646974795f67726f7373223a3432363132363039303136373830342c226c69717569646974795f6e6574223a3432363132363039303136373830342c22696e697469616c697a6564223a747275657d2c22313934353130223a7b226c69717569646974795f67726f7373223a353932303039303138373933353830372c226c69717569646974795f6e6574223a2d353932303039303138373933353830372c22696e697469616c697a6564223a747275657d2c22313933333830223a7b226c69717569646974795f67726f7373223a33313136383630373238353936343738382c226c69717569646974795f6e6574223a2d33313135323333363330383037313638342c22696e697469616c697a6564223a747275657d2c22313934323430223a7b226c69717569646974795f67726f7373223a3736363434373032313531343032362c226c69717569646974795f6e6574223a2d3736363434373032313531343032362c22696e697469616c697a6564223a747275657d2c22313936303930223a7b226c69717569646974795f67726f7373223a33363231343637373936343132333438342c226c69717569646974795f6e6574223a2d33363231343637373936343132333438342c22696e697469616c697a6564223a747275657d2c22313936373230223a7b226c69717569646974795f67726f7373223a3439343334373638343932333034322c226c69717569646974795f6e6574223a2d3439343334373638343932333034322c22696e697469616c697a6564223a747275657d2c22313939383230223a7b226c69717569646974795f67726f7373223a323230323532343433303838333132382c226c69717569646974795f6e6574223a2d323230323532343433303838333132382c22696e697469616c697a6564223a747275657d2c22313931363830223a7b226c69717569646974795f67726f7373223a3234373538373439313830373331302c226c69717569646974795f6e6574223a3234373538373439313830373331302c22696e697469616c697a6564223a747275657d2c22313932373930223a7b226c69717569646974795f67726f7373223a313633363733363638313339352c226c69717569646974795f6e6574223a313633363733363638313339352c22696e697469616c697a6564223a747275657d2c22313934333030223a7b226c69717569646974795f67726f7373223a313636373234323131373530303232382c226c69717569646974795f6e6574223a2d313636373234323131373530303232382c22696e697469616c697a6564223a747275657d2c22313932313930223a7b226c69717569646974795f67726f7373223a33383431313938363533383431372c226c69717569646974795f6e6574223a33383431313938363533383431372c22696e697469616c697a6564223a747275657d2c22313932363930223a7b226c69717569646974795f67726f7373223a32303337363933353538383036373637312c226c69717569646974795f6e6574223a32303337363933353538383036373637312c22696e697469616c697a6564223a747275657d2c22313934383530223a7b226c69717569646974795f67726f7373223a3632363031353233303935393837392c226c69717569646974795f6e6574223a2d3632363031353233303935393837392c22696e697469616c697a6564223a747275657d2c22313934313430223a7b226c69717569646974795f67726f7373223a333330363431353836383832303334362c226c69717569646974795f6e6574223a2d333330363431353836383832303334362c22696e697469616c697a6564223a747275657d2c22313930323930223a7b226c69717569646974795f67726f7373223a3732333636373835393234303431392c226c69717569646974795f6e6574223a3732333636373835393234303431392c22696e697469616c697a6564223a747275657d2c22313931303130223a7b226c69717569646974795f67726f7373223a38303739323738373036383435382c226c69717569646974795f6e6574223a38303739323738373036383435382c22696e697469616c697a6564223a747275657d2c22313931373930223a7b226c69717569646974795f67726f7373223a373032373934323933313036393235392c226c69717569646974795f6e6574223a373032373934323933313036393235392c22696e697469616c697a6564223a747275657d2c22313932353430223a7b226c69717569646974795f67726f7373223a33373130323838323430353036393937302c226c69717569646974795f6e6574223a33373130323838323430353036393937302c22696e697469616c697a6564223a747275657d2c22313934303830223a7b226c69717569646974795f67726f7373223a32383837373831353231353736353538392c226c69717569646974795f6e6574223a2d32383837373831353231353736353538392c22696e697469616c697a6564223a747275657d2c22313936323630223a7b226c69717569646974795f67726f7373223a323730373835353130343435333736382c226c69717569646974795f6e6574223a2d323730373835353130343435333736382c22696e697469616c697a6564223a747275657d2c22313932353530223a7b226c69717569646974795f67726f7373223a333534333231373937393232343333392c226c69717569646974795f6e6574223a333534333231373937393232343333392c22696e697469616c697a6564223a747275657d2c22313934373230223a7b226c69717569646974795f67726f7373223a35343739383837343839373030332c226c69717569646974795f6e6574223a2d35343739383837343839373030332c22696e697469616c697a6564223a747275657d2c22313932353230223a7b226c69717569646974795f67726f7373223a3530353939313033393939373731362c226c69717569646974795f6e6574223a3530353939313033393939373731362c22696e697469616c697a6564223a747275657d2c22313933323330223a7b226c69717569646974795f67726f7373223a31343136363130323330383435383237392c226c69717569646974795f6e6574223a2d31343136363130323330383435383237392c22696e697469616c697a6564223a747275657d2c22313934323130223a7b226c69717569646974795f67726f7373223a32363230393230373134313038312c226c69717569646974795f6e6574223a2d32363230393230373134313038312c22696e697469616c697a6564223a747275657d2c22313933393130223a7b226c69717569646974795f67726f7373223a3930383034393435373933303433392c226c69717569646974795f6e6574223a2d3930383034393435373933303433392c22696e697469616c697a6564223a747275657d2c22313931343830223a7b226c69717569646974795f67726f7373223a353932303039303138373933353830372c226c69717569646974795f6e6574223a353932303039303138373933353830372c22696e697469616c697a6564223a747275657d2c22313935303630223a7b226c69717569646974795f67726f7373223a38303739323738373036383435382c226c69717569646974795f6e6574223a2d38303739323738373036383435382c22696e697469616c697a6564223a747275657d2c22313934313530223a7b226c69717569646974795f67726f7373223a333934393531373737303530323435302c226c69717569646974795f6e6574223a2d333934393531373737303530323435302c22696e697469616c697a6564223a747275657d2c22313933323530223a7b226c69717569646974795f67726f7373223a3234373538373439313830373331302c226c69717569646974795f6e6574223a2d3234373538373439313830373331302c22696e697469616c697a6564223a747275657d2c22313934333630223a7b226c69717569646974795f67726f7373223a313230303730343435373336393433342c226c69717569646974795f6e6574223a2d313230303730343435373336393433342c22696e697469616c697a6564223a747275657d2c22313933373630223a7b226c69717569646974795f67726f7373223a3732333636373835393234303431392c226c69717569646974795f6e6574223a2d3732333636373835393234303431392c22696e697469616c697a6564223a747275657d2c22313933383730223a7b226c69717569646974795f67726f7373223a31353530323737383630363531322c226c69717569646974795f6e6574223a31353530323737383630363531322c22696e697469616c697a6564223a747275657d2c22313932333130223a7b226c69717569646974795f67726f7373223a3234313632343033303035323030322c226c69717569646974795f6e6574223a3234313632343033303035323030322c22696e697469616c697a6564223a747275657d2c22313934383630223a7b226c69717569646974795f67726f7373223a383938383039393032373030372c226c69717569646974795f6e6574223a2d383938383039393032373030372c22696e697469616c697a6564223a747275657d2c22313935303030223a7b226c69717569646974795f67726f7373223a37343130303937353138353339332c226c69717569646974795f6e6574223a2d37343130303937353138353339332c22696e697469616c697a6564223a747275657d2c22313933323230223a7b226c69717569646974795f67726f7373223a35343739383837343839373030332c226c69717569646974795f6e6574223a35343739383837343839373030332c22696e697469616c697a6564223a747275657d2c22313932323030223a7b226c69717569646974795f67726f7373223a3437393339313332303439333834392c226c69717569646974795f6e6574223a3437393339313332303439333834392c22696e697469616c697a6564223a747275657d2c22313933383930223a7b226c69717569646974795f67726f7373223a3335353639313737343835353235332c226c69717569646974795f6e6574223a2d3335353639313737343835353235332c22696e697469616c697a6564223a747275657d2c22313933313330223a7b226c69717569646974795f67726f7373223a363934373137373031373839303637392c226c69717569646974795f6e6574223a353137303736383133353939373730372c22696e697469616c697a6564223a747275657d2c22313933333530223a7b226c69717569646974795f67726f7373223a323035313630393636363032323833342c226c69717569646974795f6e6574223a2d323035313630393636363032323833342c22696e697469616c697a6564223a747275657d2c22313934333430223a7b226c69717569646974795f67726f7373223a3433313338373034323637363030392c226c69717569646974795f6e6574223a2d3433313338373034323637363030392c22696e697469616c697a6564223a747275657d2c22313934393030223a7b226c69717569646974795f67726f7373223a37303539363637393237393230352c226c69717569646974795f6e6574223a2d37303539363637393237393230352c22696e697469616c697a6564223a747275657d2c22313932333530223a7b226c69717569646974795f67726f7373223a323035313630393636363032323833342c226c69717569646974795f6e6574223a323035313630393636363032323833342c22696e697469616c697a6564223a747275657d2c22313933343130223a7b226c69717569646974795f67726f7373223a31323231333131393337313533393331312c226c69717569646974795f6e6574223a2d31323231333131393337313533393331312c22696e697469616c697a6564223a747275657d2c22313934303130223a7b226c69717569646974795f67726f7373223a32363230393230373134313038312c226c69717569646974795f6e6574223a32363230393230373134313038312c22696e697469616c697a6564223a747275657d2c22313933373330223a7b226c69717569646974795f67726f7373223a333436303735303637393132383736372c226c69717569646974795f6e6574223a333436303735303637393132383736372c22696e697469616c697a6564223a747275657d2c22313934393330223a7b226c69717569646974795f67726f7373223a3630363339373034313331313530302c226c69717569646974795f6e6574223a2d3630363339373034313331313530302c22696e697469616c697a6564223a747275657d2c22313932383930223a7b226c69717569646974795f67726f7373223a363434393637313139383631393832382c226c69717569646974795f6e6574223a3631353236343232323131333939302c22696e697469616c697a6564223a747275657d2c22313936313330223a7b226c69717569646974795f67726f7373223a3136343531303636363334353937332c226c69717569646974795f6e6574223a2d3136343531303636363334353937332c22696e697469616c697a6564223a747275657d2c22313933333030223a7b226c69717569646974795f67726f7373223a3738353334383233313936313336332c226c69717569646974795f6e6574223a3738353334383233313936313336332c22696e697469616c697a6564223a747275657d2c22313936313530223a7b226c69717569646974795f67726f7373223a313633363733363638313339352c226c69717569646974795f6e6574223a2d313633363733363638313339352c22696e697469616c697a6564223a747275657d2c22313933303830223a7b226c69717569646974795f67726f7373223a393632343831303135383830352c226c69717569646974795f6e6574223a393632343831303135383830352c22696e697469616c697a6564223a747275657d2c22313932373630223a7b226c69717569646974795f67726f7373223a33313332363235353633323233333838362c226c69717569646974795f6e6574223a33313332363235353633323233333838362c22696e697469616c697a6564223a747275657d2c22313934363130223a7b226c69717569646974795f67726f7373223a3432363132363039303136373830342c226c69717569646974795f6e6574223a2d3432363132363039303136373830342c22696e697469616c697a6564223a747275657d2c22313839343430223a7b226c69717569646974795f67726f7373223a3439343334373638343932333034322c226c69717569646974795f6e6574223a3439343334373638343932333034322c22696e697469616c697a6564223a747275657d2c22313931393130223a7b226c69717569646974795f67726f7373223a3330383431363234333738333334342c226c69717569646974795f6e6574223a3330383431363234333738333334342c22696e697469616c697a6564223a747275657d2c22313931393030223a7b226c69717569646974795f67726f7373223a3530303239373139303132363730362c226c69717569646974795f6e6574223a3530303239373139303132363730362c22696e697469616c697a6564223a747275657d2c22313932383430223a7b226c69717569646974795f67726f7373223a3830313931303332393531353937372c226c69717569646974795f6e6574223a2d3830313931303332393531353937372c22696e697469616c697a6564223a747275657d2c22313838313330223a7b226c69717569646974795f67726f7373223a31303632363630313933363732353737342c226c69717569646974795f6e6574223a31303632363630313933363732353737342c22696e697469616c697a6564223a747275657d2c22313932343830223a7b226c69717569646974795f67726f7373223a3436393438383735343331333037332c226c69717569646974795f6e6574223a3436393438383735343331333037332c22696e697469616c697a6564223a747275657d2c22313936333030223a7b226c69717569646974795f67726f7373223a313439393738363830303436342c226c69717569646974795f6e6574223a2d313439393738363830303436342c22696e697469616c697a6564223a747275657d2c22313935343130223a7b226c69717569646974795f67726f7373223a3738353334383233313936313336332c226c69717569646974795f6e6574223a2d3738353334383233313936313336332c22696e697469616c697a6564223a747275657d2c22313933373930223a7b226c69717569646974795f67726f7373223a373032373934323933313036393235392c226c69717569646974795f6e6574223a2d373032373934323933313036393235392c22696e697469616c697a6564223a747275657d2c22323033313930223a7b226c69717569646974795f67726f7373223a363335393231323336393236373431372c226c69717569646974795f6e6574223a2d363335393231323336393236373431372c22696e697469616c697a6564223a747275657d2c22313931383130223a7b226c69717569646974795f67726f7373223a3132353633353030383738393630372c226c69717569646974795f6e6574223a3132353633353030383738393630372c22696e697469616c697a6564223a747275657d2c22313933313730223a7b226c69717569646974795f67726f7373223a323139383639393831323535322c226c69717569646974795f6e6574223a2d323139383639393831323535322c22696e697469616c697a6564223a747275657d2c22313932363430223a7b226c69717569646974795f67726f7373223a313439393738363830303436342c226c69717569646974795f6e6574223a313439393738363830303436342c22696e697469616c697a6564223a747275657d2c22313934383130223a7b226c69717569646974795f67726f7373223a3436323639303436313336333632302c226c69717569646974795f6e6574223a2d3436323639303436313336333632302c22696e697469616c697a6564223a747275657d2c22313933313930223a7b226c69717569646974795f67726f7373223a35333735343139383134333233333937322c226c69717569646974795f6e6574223a2d35333735343139383134333233333937322c22696e697469616c697a6564223a747275657d2c22313933363630223a7b226c69717569646974795f67726f7373223a313433303738383234343238353439392c226c69717569646974795f6e6574223a2d313433303738383234343238353439392c22696e697469616c697a6564223a747275657d2c22313935333530223a7b226c69717569646974795f67726f7373223a31323939373939363131343831353437322c226c69717569646974795f6e6574223a2d31323939373939363131343831353437322c22696e697469616c697a6564223a747275657d2c22313937373030223a7b226c69717569646974795f67726f7373223a3132353633353030383738393630372c226c69717569646974795f6e6574223a2d3132353633353030383738393630372c22696e697469616c697a6564223a747275657d2c22313934393630223a7b226c69717569646974795f67726f7373223a31353530323737383630363531322c226c69717569646974795f6e6574223a2d31353530323737383630363531322c22696e697469616c697a6564223a747275657d2c22313935303830223a7b226c69717569646974795f67726f7373223a393632343831303135383830352c226c69717569646974795f6e6574223a2d393632343831303135383830352c22696e697469616c697a6564223a747275657d2c22313932373730223a7b226c69717569646974795f67726f7373223a3930383034393435373933303433392c226c69717569646974795f6e6574223a3930383034393435373933303433392c22696e697469616c697a6564223a747275657d2c22313932303830223a7b226c69717569646974795f67726f7373223a323230323532343433303838333132382c226c69717569646974795f6e6574223a323230323532343433303838333132382c22696e697469616c697a6564223a747275657d2c22313932343930223a7b226c69717569646974795f67726f7373223a31323939373939363131343831353437322c226c69717569646974795f6e6574223a31323939373939363131343831353437322c22696e697469616c697a6564223a747275657d2c22313936383730223a7b226c69717569646974795f67726f7373223a313131363435323836393232392c226c69717569646974795f6e6574223a2d313131363435323836393232392c22696e697469616c697a6564223a747275657d2c22313932313530223a7b226c69717569646974795f67726f7373223a313636373234323131373530303232382c226c69717569646974795f6e6574223a313636373234323131373530303232382c22696e697469616c697a6564223a747275657d2c22313933333730223a7b226c69717569646974795f67726f7373223a313634343431353935383034303135382c226c69717569646974795f6e6574223a313634343431353935383034303135382c22696e697469616c697a6564223a747275657d2c22313836363630223a7b226c69717569646974795f67726f7373223a36333239393332363532313434392c226c69717569646974795f6e6574223a36333239393332363532313434392c22696e697469616c697a6564223a747275657d2c22313935333930223a7b226c69717569646974795f67726f7373223a3436393438383735343331333037332c226c69717569646974795f6e6574223a2d3436393438383735343331333037332c22696e697469616c697a6564223a747275657d2c22313932383130223a7b226c69717569646974795f67726f7373223a3835383137313032393339332c226c69717569646974795f6e6574223a3835383137313032393339332c22696e697469616c697a6564223a747275657d2c22313933373830223a7b226c69717569646974795f67726f7373223a383938383039393032373030372c226c69717569646974795f6e6574223a383938383039393032373030372c22696e697469616c697a6564223a747275657d2c22313931303030223a7b226c69717569646974795f67726f7373223a3233333435333434333830303938322c226c69717569646974795f6e6574223a3233333435333434333830303938322c22696e697469616c697a6564223a747275657d2c22313934353230223a7b226c69717569646974795f67726f7373223a3530353939313033393939373731362c226c69717569646974795f6e6574223a2d3530353939313033393939373731362c22696e697469616c697a6564223a747275657d2c22313933313030223a7b226c69717569646974795f67726f7373223a3239313238323436323339373538382c226c69717569646974795f6e6574223a3239313238323436323339373538382c22696e697469616c697a6564223a747275657d2c22313839393830223a7b226c69717569646974795f67726f7373223a36393732373037313532373837352c226c69717569646974795f6e6574223a36393732373037313532373837352c22696e697469616c697a6564223a747275657d2c22313838383830223a7b226c69717569646974795f67726f7373223a3834383533313833313331343430352c226c69717569646974795f6e6574223a3834383533313833313331343430352c22696e697469616c697a6564223a747275657d2c22313938393130223a7b226c69717569646974795f67726f7373223a33373135373836333439343039342c226c69717569646974795f6e6574223a2d33373135373836333439343039342c22696e697469616c697a6564223a747275657d2c22313935303730223a7b226c69717569646974795f67726f7373223a373730343837363434303832322c226c69717569646974795f6e6574223a2d373730343837363434303832322c22696e697469616c697a6564223a747275657d2c22313931393930223a7b226c69717569646974795f67726f7373223a32343536313938383639383639352c226c69717569646974795f6e6574223a32343536313938383639383639352c22696e697469616c697a6564223a747275657d2c22313934333930223a7b226c69717569646974795f67726f7373223a3234313632343033303035323030322c226c69717569646974795f6e6574223a2d3234313632343033303035323030322c22696e697469616c697a6564223a747275657d2c22313935333430223a7b226c69717569646974795f67726f7373223a313634343431353935383034303135382c226c69717569646974795f6e6574223a2d313634343431353935383034303135382c22696e697469616c697a6564223a747275657d2c22313933383430223a7b226c69717569646974795f67726f7373223a3233333435333434333830303938322c226c69717569646974795f6e6574223a2d3233333435333434333830303938322c22696e697469616c697a6564223a747275657d2c22313931383730223a7b226c69717569646974795f67726f7373223a37303539363637393237393230352c226c69717569646974795f6e6574223a37303539363637393237393230352c22696e697469616c697a6564223a747275657d2c22313934393230223a7b226c69717569646974795f67726f7373223a363431393437363730333836383332302c226c69717569646974795f6e6574223a2d363431393437363730333836383332302c22696e697469616c697a6564223a747275657d2c22313936323130223a7b226c69717569646974795f67726f7373223a3437383733383937373637393932362c226c69717569646974795f6e6574223a2d3437383733383937373637393932362c22696e697469616c697a6564223a747275657d2c22313739353130223a7b226c69717569646974795f67726f7373223a383531323036333334363431383639372c226c69717569646974795f6e6574223a383531323036333334363431383639372c22696e697469616c697a6564223a747275657d2c22313934363930223a7b226c69717569646974795f67726f7373223a343430313230383336343833383731332c226c69717569646974795f6e6574223a2d343430313230383336343833383731332c22696e697469616c697a6564223a747275657d2c22313932333930223a7b226c69717569646974795f67726f7373223a33353638383938383634363937362c226c69717569646974795f6e6574223a33353638383938383634363937362c22696e697469616c697a6564223a747275657d2c22313932363130223a7b226c69717569646974795f67726f7373223a31343136363130323330383435383237392c226c69717569646974795f6e6574223a31343136363130323330383435383237392c22696e697469616c697a6564223a747275657d2c22313936333330223a7b226c69717569646974795f67726f7373223a333036343730363634373730313638362c226c69717569646974795f6e6574223a2d333036343730363634373730313638362c22696e697469616c697a6564223a747275657d2c22313934393130223a7b226c69717569646974795f67726f7373223a333333323433353732333037343836312c226c69717569646974795f6e6574223a2d333333323433353732333037343836312c22696e697469616c697a6564223a747275657d2c22313931313530223a7b226c69717569646974795f67726f7373223a3830313931303332393531353937372c226c69717569646974795f6e6574223a3830313931303332393531353937372c22696e697469616c697a6564223a747275657d2c22313931363730223a7b226c69717569646974795f67726f7373223a313133373530333135303839383434332c226c69717569646974795f6e6574223a313133373530333135303839383434332c22696e697469616c697a6564223a747275657d2c22313931333830223a7b226c69717569646974795f67726f7373223a393537303631333736373436303337382c226c69717569646974795f6e6574223a393537303631333736373436303337382c22696e697469616c697a6564223a747275657d2c22313932393130223a7b226c69717569646974795f67726f7373223a333637373530373835393439383232382c226c69717569646974795f6e6574223a333637373530373835393439383232382c22696e697469616c697a6564223a747275657d2c22313936383130223a7b226c69717569646974795f67726f7373223a313237333136383836393637372c226c69717569646974795f6e6574223a2d313237333136383836393637372c22696e697469616c697a6564223a747275657d2c22313932323830223a7b226c69717569646974795f67726f7373223a333036343730363634373730313638362c226c69717569646974795f6e6574223a333036343730363634373730313638362c22696e697469616c697a6564223a747275657d2c22313932373230223a7b226c69717569646974795f67726f7373223a3332303930313230313230363530322c226c69717569646974795f6e6574223a3332303930313230313230363530322c22696e697469616c697a6564223a747275657d2c22313932393230223a7b226c69717569646974795f67726f7373223a363637303635303833333534363934372c226c69717569646974795f6e6574223a363032383834383433313133333934332c22696e697469616c697a6564223a747275657d2c22313932323630223a7b226c69717569646974795f67726f7373223a35333735343139383134333233333937322c226c69717569646974795f6e6574223a35333735343139383134333233333937322c22696e697469616c697a6564223a747275657d2c22313932353830223a7b226c69717569646974795f67726f7373223a323139383639393831323535322c226c69717569646974795f6e6574223a323139383639393831323535322c22696e697469616c697a6564223a747275657d2c22313933333430223a7b226c69717569646974795f67726f7373223a3433313338373034323637363030392c226c69717569646974795f6e6574223a3433313338373034323637363030392c22696e697469616c697a6564223a747275657d2c22313933383530223a7b226c69717569646974795f67726f7373223a3632363031353233303935393837392c226c69717569646974795f6e6574223a3632363031353233303935393837392c22696e697469616c697a6564223a747275657d2c22313936353330223a7b226c69717569646974795f67726f7373223a393537303631333736373436303337382c226c69717569646974795f6e6574223a2d393537303631333736373436303337382c22696e697469616c697a6564223a747275657d2c22313936353430223a7b226c69717569646974795f67726f7373223a31363531393237343431343130343830362c226c69717569646974795f6e6574223a2d31363531393237343431343130343830362c22696e697469616c697a6564223a747275657d2c22313934373130223a7b226c69717569646974795f67726f7373223a31303132363035353137383437333831322c226c69717569646974795f6e6574223a2d31303132363035353137383437333831322c22696e697469616c697a6564223a747275657d2c22313932383230223a7b226c69717569646974795f67726f7373223a313131363435323836393232392c226c69717569646974795f6e6574223a313131363435323836393232392c22696e697469616c697a6564223a747275657d2c22313935373230223a7b226c69717569646974795f67726f7373223a313133373530333135303839383434332c226c69717569646974795f6e6574223a2d313133373530333135303839383434332c22696e697469616c697a6564223a747275657d2c22313932333630223a7b226c69717569646974795f67726f7373223a3434383438373431373033323933382c226c69717569646974795f6e6574223a3434383438373431373033323933382c22696e697469616c697a6564223a747275657d2c22313938313030223a7b226c69717569646974795f67726f7373223a3330383431363234333738333334342c226c69717569646974795f6e6574223a2d3330383431363234333738333334342c22696e697469616c697a6564223a747275657d7d2c227469636b5f6269746d6170223a7b223733223a223078313030303030303030303030303030303030303230303030303030303030303030303030303030303030303030303030303030222c223734223a22307863306338323838313830303031303034303030303038343033303030303031303030303030303030303032303030303030303430303030303030303030303031222c223732223a2230783430303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303230303030303030303030222c223730223a2230783830303030303030222c223735223a22307831383030396334313231633130323038616230643230343230303030323763343265616135383030316131366231323132346433346139393934313838313032222c223739223a223078383030303030303030303030303030303030303030303030222c223736223a22307834303030303063323031303030303630303030323434323061323030303030303030313030323030303032386330303030303563313133633632303161303230222c223737223a223078383030303030303030303030303030303030303034303030303030303030343030303030303030303030303030222c223738223a223078343030303034303030222c22313833223a223078323030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030227d7d2c22626c6f636b223a302c22666565223a3335307d2c305d7d5d"
);

const TEST_BLOCK: u64 = 23112425;

// ERROR result=Revert { gas_used: 128588, output: 0x8e1edfa4 }
// block_number=23112268
#[tokio::test(flavor = "multi_thread", worker_threads = 5)]
pub async fn test_limit_being_violated() {
    init_with_chain_id(1);
    init_tracing();

    let channels = initialize_strom_handles();
    let validation_client = ValidationClient(channels.validator_tx.clone());
    let url = std::env::var("RPC_URL").unwrap();

    let querying_provider: Arc<_> = ProviderBuilder::<_, _, Ethereum>::default()
        .with_recommended_fillers()
        // backup
        .connect(&url)
        .await
        .unwrap()
        .into();

    let block_id = querying_provider.get_block_number().await.unwrap();

    let angstrom_address = *ANGSTROM_ADDRESS.get().unwrap();
    let controller = *CONTROLLER_V1_ADDRESS.get().unwrap();
    let deploy_block = *ANGSTROM_DEPLOYED_BLOCK.get().unwrap();
    let gas_token = *GAS_TOKEN_ADDRESS.get().unwrap();
    let pool_manager = *POOL_MANAGER_ADDRESS.get().unwrap();

    let pool_config_store = Arc::new(
        AngstromPoolConfigStore::load_from_chain(
            angstrom_address,
            BlockId::Number(BlockNumberOrTag::Latest),
            &querying_provider
        )
        .await
        .unwrap()
    );

    // load the angstrom pools;
    tracing::info!("starting search for pools");

    let global_block_sync = GlobalBlockSync::new(block_id);

    let (tx, rx) = tokio::sync::broadcast::channel(50);

    let (wrap_tx, wrap_rx) = tokio::sync::broadcast::channel(50);

    let network_stream = Box::pin(
        tokio_stream::wrappers::BroadcastStream::new(wrap_rx)
            .map(|data: Result<EthEvent, _>| data.unwrap())
    );

    let (pool_tx, _) = tokio::sync::mpsc::channel(50);
    let pools = SyncedUniswapPools::new(Default::default(), pool_tx);

    let price_generator = TokenPriceGenerator::new(
        querying_provider.clone(),
        block_id,
        pools.clone(),
        gas_token,
        None
    )
    .await
    .expect("failed to start token price generator");
    let stream = MockStream { tx: tx.clone() };

    let update_stream = Box::pin(PairsWithPrice::into_price_update_stream(
        angstrom_address,
        stream.canonical_state_stream(),
        querying_provider.clone()
    ));

    let (limit, searcher, pool_snapshots) = serde_json::from_slice(&PAYLOAD).unwrap();

    init_validation(
        StateProvider { provider: querying_provider.clone() },
        block_id,
        angstrom_address,
        address!("0xc41ae140ca9b281d8a1dc254c50e446019517d04"),
        update_stream,
        pools.clone(),
        price_generator,
        pool_config_store.clone(),
        channels.validator_rx
    );

    let executor = TokioTaskExecutor::default();
    let matching_manager = MatchingManager::new(executor, validation_client.clone());

    let output = matching_manager
        .build_proposal(limit, searcher, pool_snapshots)
        .await
        .unwrap();

    assert!(true);
}

async fn fetch_angstrom_pools<P>(
    // the block angstrom was deployed at
    mut deploy_block: usize,
    end_block: usize,
    angstrom_address: Address,
    db: &P
) -> Vec<PoolKey>
where
    P: Provider
{
    let mut filters = vec![];
    let controller_address = *CONTROLLER_V1_ADDRESS.get().unwrap();

    loop {
        let this_end_block = std::cmp::min(deploy_block + 99_999, end_block);

        if this_end_block == deploy_block {
            break;
        }

        let filter = Filter::new()
            .from_block(deploy_block as u64)
            .to_block(this_end_block as u64)
            .address(controller_address);

        filters.push(filter);

        deploy_block = std::cmp::min(end_block, this_end_block);
    }

    let logs = futures::stream::iter(filters)
        .map(|filter| async move {
            db.get_logs(&filter)
                .await
                .unwrap()
                .into_iter()
                .collect::<Vec<_>>()
        })
        .buffered(10)
        .collect::<Vec<_>>()
        .await
        .into_iter()
        .flatten()
        .collect::<Vec<_>>();

    logs.into_iter()
        .fold(HashSet::new(), |mut set, log| {
            if let Ok(pool) = PoolConfigured::decode_log(&log.clone().into_inner()) {
                let pool_key = PoolKey {
                    currency0:   pool.asset0,
                    currency1:   pool.asset1,
                    fee:         pool.bundleFee,
                    tickSpacing: I24::try_from_be_slice(&{
                        let bytes = pool.tickSpacing.to_be_bytes();
                        let mut a = [0u8; 3];
                        a[1..3].copy_from_slice(&bytes);
                        a
                    })
                    .unwrap(),
                    hooks:       angstrom_address
                };

                set.insert(pool_key);
                return set;
            }

            if let Ok(pool) = PoolRemoved::decode_log(&log.clone().into_inner()) {
                let pool_key = PoolKey {
                    currency0:   pool.asset0,
                    currency1:   pool.asset1,
                    fee:         pool.feeInE6,
                    tickSpacing: pool.tickSpacing,
                    hooks:       angstrom_address
                };

                set.remove(&pool_key);
                return set;
            }
            set
        })
        .into_iter()
        .collect::<Vec<_>>()
}

pub fn init_tracing() {
    let envfilter = filter::EnvFilter::builder().try_from_env().ok();
    let format = tracing_subscriber::fmt::layer()
        .with_ansi(true)
        .with_target(true);

    let _ = tracing_subscriber::registry()
        .with(format)
        .with(envfilter)
        .try_init();
}

fn layer_builder(filter_str: String) -> Box<dyn Layer<Registry> + Send + Sync> {
    let filter = EnvFilter::builder()
        .with_default_directive(filter_str.parse().unwrap())
        .from_env_lossy();

    tracing_subscriber::fmt::layer()
        .with_ansi(true)
        .with_target(true)
        .with_filter(filter)
        .boxed()
}

pub struct MockStream {
    tx: tokio::sync::broadcast::Sender<CanonStateNotification>
}

impl NodePrimitivesProvider for MockStream {
    type Primitives = EthPrimitives;
}

impl CanonStateSubscriptions for MockStream {
    fn subscribe_to_canonical_state(
        &self
    ) -> reth_provider::CanonStateNotifications<Self::Primitives> {
        self.tx.subscribe()
    }
}

#[derive(Debug, Clone)]
pub struct StateProvider<P> {
    provider: Arc<P>
}

impl<P: Send + Sync + 'static> SetBlock for StateProvider<P> {
    fn set_block(&self, _: u64) {}
}

impl<P: Provider> reth_revm::DatabaseRef for StateProvider<P> {
    type Error = DBError;

    fn basic_ref(&self, address: Address) -> Result<Option<AccountInfo>, Self::Error> {
        let acc = async_to_sync(
            self.provider
                .get_account(address)
                .block_id(TEST_BLOCK.into())
                .into_future()
        )
        .unwrap_or_default();

        let code = async_to_sync(
            self.provider
                .get_code_at(address)
                .block_id(TEST_BLOCK.into())
                .into_future()
        )
        .ok()
        .map(Bytecode::new_raw);

        Ok(Some(AccountInfo {
            code_hash: acc.code_hash,
            balance: acc.balance,
            nonce: acc.nonce,
            code
        }))
    }

    fn storage_ref(&self, address: Address, index: U256) -> Result<U256, Self::Error> {
        let acc = async_to_sync(
            self.provider
                .get_storage_at(address, index)
                .block_id(TEST_BLOCK.into())
                .into_future()
        )
        .unwrap();
        Ok(acc)
    }

    fn block_hash_ref(&self, number: u64) -> Result<B256, Self::Error> {
        let acc = async_to_sync(
            self.provider
                .get_block_by_number(alloy_rpc_types::BlockNumberOrTag::Number(number))
                .into_future()
        )
        .unwrap()
        .unwrap();

        // let Some(block) = acc else { return Err(DBError::String("no
        // block".to_string())) };
        Ok(acc.header.hash)
    }

    fn code_by_hash_ref(&self, code: B256) -> Result<Bytecode, Self::Error> {
        let code = async_to_sync(
            self.provider
                .debug_code_by_hash(code, Some(TEST_BLOCK.into()))
                .into_future()
        )
        .unwrap()
        .unwrap_or_default();

        Ok(Bytecode::new_raw(code))
    }
}
impl<P: Provider> BlockNumReader for StateProvider<P> {
    fn chain_info(&self) -> ProviderResult<reth::chainspec::ChainInfo> {
        panic!("never used");
    }

    fn block_number(&self, _: alloy_primitives::B256) -> ProviderResult<Option<BlockNumber>> {
        panic!("never used");
    }

    fn convert_number(
        &self,
        _: alloy_rpc_types::BlockHashOrNumber
    ) -> ProviderResult<Option<alloy_primitives::B256>> {
        panic!("never used");
    }

    fn best_block_number(&self) -> ProviderResult<BlockNumber> {
        Ok(async_to_sync(self.provider.get_block_number().into_future()).unwrap())
    }

    fn last_block_number(&self) -> ProviderResult<BlockNumber> {
        Ok(async_to_sync(self.provider.get_block_number().into_future()).unwrap())
    }

    fn convert_hash_or_number(
        &self,
        _: alloy_rpc_types::BlockHashOrNumber
    ) -> ProviderResult<Option<BlockNumber>> {
        panic!("never used");
    }
}
impl<P: Provider> BlockHashReader for StateProvider<P> {
    fn block_hash(&self, _: BlockNumber) -> ProviderResult<Option<alloy_primitives::B256>> {
        panic!("never used");
    }

    fn convert_block_hash(
        &self,
        _: alloy_rpc_types::BlockHashOrNumber
    ) -> ProviderResult<Option<alloy_primitives::B256>> {
        panic!("never used");
    }

    fn canonical_hashes_range(
        &self,
        _: BlockNumber,
        _: BlockNumber
    ) -> ProviderResult<Vec<alloy_primitives::B256>> {
        panic!("never used");
    }
}

pub fn async_to_sync<F: Future>(f: F) -> F::Output {
    let handle = tokio::runtime::Handle::try_current().expect("No tokio runtime found");
    tokio::task::block_in_place(|| handle.block_on(f))
}
